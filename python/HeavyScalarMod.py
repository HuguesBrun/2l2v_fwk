from HiggsAnalysis.CombinedLimit.PhysicsModel import *


### This is the base python class to study the Higgs width

class HeavyScalarMod(PhysicsModel):
    def __init__(self):
        self.mHRange = []
        self.GGsmfixed = False
        self.is2l2nu = False
        self.poiMap = []
        self.pois = {}
        self.verbose = False
        self.xsec= 1.0
        self.xsec_vbf= 1.0
        self.m= 200
        self.w= 10.
    def setModelBuilder(self, modelBuilder):
        PhysicsModel.setModelBuilder(self,modelBuilder)
        self.modelBuilder.doModelBOnly = False

    def getYieldScale(self,bin,process):
        if process == "ggH_sonl": return "ggH_s_func"
        elif process == "ggH_bonl": return "ggH_b_func"
        elif process == "ggH_sand": return "ggH_sbi_func"
        if process == "qqH_sonl": return "qqH_s_func"
        elif process == "qqH_bonl": return "qqH_b_func"
        elif process == "qqH_sand": return "qqH_sbi_func"
        else:
            return 1

    def setPhysicsOptions(self,physOptions):
        for po in physOptions:
            if po == "GGsmfixed":
                print "Will fix CMS_zz4l_GGsm to 1 and float mu"
                self.GGsmfixed = True
            if po == "is2l2nu":
                print "Will consider cards in 2l2nu style (separated S, B, S+B+I)"
                self.is2l2nu = True
            if po == "muAsPOI":
                print "Will combine all ZZ cards"
                self.isCombine = True
            if po.startswith("m="):
                self.m = float(po.replace("m=",""))
                print "mass = ",self.m
            if po.startswith("w="):
                self.w = float(po.replace("w=",""))
                print "width = ",self.w

    def setXsec(self):
        theXsectionGGHtable =  [[0.129026, 0.108295, 0.0563934, 0.0390144, 0.0302842, 0.0250185, 0.0214859, 0.0189436, 0.01702, 0.0155091, 0.0142871, 0.0132756, 0.012422, 0.0116903, 0.0110547, 0.0104961],
                                [0.155452, 0.130701, 0.0634882, 0.0450126, 0.0341044, 0.0284839, 0.0245929, 0.0213219, 0.0192034, 0.0172584, 0.0159102, 0.014778, 0.0136639, 0.0128467, 0.0120192, 0.0113972],
                                [0.201715, 0.145968, 0.0756923, 0.0542553, 0.0411177, 0.0332919, 0.028076, 0.0243373, 0.0218773, 0.0195946, 0.0177612, 0.0162534, 0.0149896, 0.0140573, 0.0131097, 0.0122842],
                                [0.309288, 0.221361, 0.111842, 0.0715992, 0.0544462, 0.0439144, 0.036791, 0.0316518, 0.0272898, 0.0243491, 0.0219767, 0.020022, 0.0183831, 0.0168067, 0.0156304, 0.0146053],
                                [0.38381, 0.240165, 0.127069, 0.0818579, 0.062118, 0.0485159, 0.0396852, 0.0341689, 0.0294346, 0.0262191, 0.0232811, 0.0209125, 0.0191879, 0.0175215, 0.016274, 0.0150399],
                                [0.442906, 0.274057, 0.134286, 0.087915, 0.0648232, 0.0510393, 0.0419044, 0.0354209, 0.03059, 0.0268572, 0.0238903, 0.0214782, 0.0194806, 0.0178005, 0.0163688, 0.0151352],
                                [0.47121, 0.292698, 0.13441, 0.089659, 0.0646509, 0.0514934, 0.0425888, 0.0354927, 0.0308097, 0.0267416, 0.0238737, 0.0215176, 0.0193267, 0.0176933, 0.0161306, 0.0149368],
                                [0.474422, 0.26377, 0.130391, 0.0891122, 0.0651364, 0.0509322, 0.0415497, 0.0349034, 0.030445, 0.0265258, 0.0234255, 0.0209162, 0.018847, 0.0172924, 0.0157956, 0.0145125],
                                [0.422065, 0.233577, 0.114824, 0.0721715, 0.0534981, 0.0421595, 0.0345607, 0.0291252, 0.0246629, 0.0215868, 0.0191294, 0.0171246, 0.0154606, 0.0139173, 0.0127431, 0.0117305],
                                [0.41963, 0.207941, 0.107395, 0.0688388, 0.0515114, 0.0399101, 0.0323378, 0.0274767, 0.0234286, 0.0206062, 0.0181063, 0.0160923, 0.0145899, 0.0131848, 0.0121079, 0.0110774],
                                [0.413368, 0.203848, 0.0996261, 0.0650135, 0.0477521, 0.0374254, 0.0305651, 0.0256852, 0.0220425, 0.0192244, 0.0169831, 0.0151608, 0.0136524, 0.0123852, 0.011307, 0.0103798],
                                [0.335121, 0.150255, 0.0734791, 0.0480066, 0.0353057, 0.0277033, 0.0226484, 0.0190489, 0.0163591, 0.0142755, 0.0126163, 0.0112655, 0.0101459, 0.00920411, 0.00840182, 0.00771103],
                                [0.293565, 0.120658, 0.059147, 0.0386979, 0.0284974, 0.0223918, 0.0183319, 0.0154398, 0.0132772, 0.0116006, 0.010264, 0.00917467, 0.00827069, 0.00750924, 0.00685973, 0.00629974],
                                [0.313532, 0.118972, 0.0586124, 0.0385044, 0.0284493, 0.0224179, 0.018399, 0.0155304, 0.013381, 0.0117113, 0.0103778, 0.0092889, 0.00838368, 0.00761988, 0.0069673, 0.00640378],
                                [0.277945, 0.0972445, 0.047656, 0.0312453, 0.0230605, 0.0181592, 0.0148987, 0.0125752, 0.0108368, 0.00948815, 0.00841196, 0.00753377, 0.006804, 0.00618831, 0.00566224, 0.00520784],
                                [0.198556, 0.0656534, 0.0324222, 0.0213542, 0.0158181, 0.0124943, 0.0102773, 0.00869339, 0.00750546, 0.00658178, 0.00584326, 0.00523955, 0.00473705, 0.0043125, 0.00394926, 0.00363512],
                                [0.171335, 0.0534971, 0.0264483, 0.0174264, 0.0129151, 0.0102079, 0.00840283, 0.00711343, 0.00614643, 0.00539446, 0.00479311, 0.00430138, 0.00389192, 0.0035458, 0.00324951, 0.00299313],
                                [0.166377, 0.0484414, 0.0240257, 0.0158811, 0.0118025, 0.00935024, 0.00771195, 0.0065396, 0.00565907, 0.00497351, 0.0044247, 0.00397553, 0.00360121, 0.00328458, 0.00301332, 0.00277842],
                                [0.141839, 0.0402627, 0.0199626, 0.0131644, 0.00976953, 0.0077356, 0.00638104, 0.00541402, 0.00468884, 0.00412471, 0.00367323, 0.00330367, 0.00299557, 0.00273477, 0.00251118, 0.00231739],
                                [0.124359, 0.0300187, 0.0148326, 0.00983708, 0.00733734, 0.00583191, 0.00482394, 0.00410096, 0.00355668, 0.00313195, 0.00279119, 0.00251173, 0.00227837, 0.00208061, 0.0019109, 0.00176369],
                                [0.103775, 0.0255723, 0.0126117, 0.0083227, 0.00618825, 0.00490977, 0.00405751, 0.00344828, 0.00299079, 0.00263443, 0.00234887, 0.00211484, 0.0019195, 0.00175396, 0.00161187, 0.00148859],
                                [0.0647529, 0.0130448, 0.00650505, 0.00431638, 0.00321898, 0.00255894, 0.00211794, 0.00180227, 0.00156504, 0.00138015, 0.00123194, 0.00111043, 0.00100899, 0.000922983, 0.000849134, 0.000785024],
                                [0.0388067, 0.00634208, 0.00315917, 0.00209962, 0.00156972, 0.00125133, 0.00103861, 0.000886278, 0.00077169, 0.000682283, 0.000610517, 0.000551596, 0.000502322, 0.00046048, 0.00042449, 0.00039319],
                                [0.0187959, 0.00270132, 0.00134683, 0.000899284, 0.00067641, 0.00054272, 0.000453388, 0.000389319, 0.000341013, 0.000303209, 0.00027276, 0.000247669, 0.000226603, 0.000208642, 0.000193129, 0.000179583],
                                [0.0106474, 0.00133614, 0.000678998, 0.000457683, 0.000346709, 0.000279976, 0.000235336, 0.000203293, 0.000179107, 0.000160151, 0.000144854, 0.000132216, 0.000121576, 0.000112476, 0.000104588, 9.76739e-05],
                                [0.00629752, 0.000719038, 0.000371579, 0.000254694, 0.000195761, 0.00016006, 0.000135998, 0.000118601, 0.00010538, 9.49507e-05, 8.64811e-05, 7.94422e-05, 7.34809e-05, 6.83528e-05, 6.38832e-05, 5.99438e-05],
                                [0.00368874, 0.000383269, 0.000199382, 0.000138004, 0.000107135, 8.84515e-05, 7.58549e-05, 6.67343e-05, 5.9786e-05, 5.42869e-05, 4.98037e-05, 4.60612e-05, 4.2876e-05, 4.01216e-05, 3.77076e-05, 3.55679e-05],
                                [0.00155714, 0.000154715, 8.17259e-05, 5.74251e-05, 4.51846e-05, 3.77563e-05, 3.27317e-05, 2.90798e-05, 2.62857e-05, 2.40637e-05, 2.22427e-05, 2.07141e-05, 1.94055e-05, 1.8267e-05, 1.7263e-05, 1.63674e-05],
                                [0.000917852, 8.54481e-05, 4.60855e-05, 3.29052e-05, 2.62694e-05, 2.2243e-05, 1.95157e-05, 1.75276e-05, 1.60002e-05, 1.47791e-05, 1.37725e-05, 1.29218e-05, 1.21884e-05, 1.15456e-05, 1.09745e-05, 1.04611e-05]]

        theXsectionVBFtable =  [[0.0426389, 0.0356677, 0.01824, 0.0124292, 0.00952258, 0.00777785, 0.00661407, 0.00578222, 0.00515779, 0.00467161, 0.00428219, 0.00396313, 0.00369682, 0.00347109, 0.00327723, 0.00310887],
                                [0.0492355, 0.0410812, 0.0192488, 0.013375, 0.00995466, 0.00821559, 0.00702644, 0.00604037, 0.00541076, 0.00484085, 0.00445146, 0.00412866, 0.00381539, 0.00358869, 0.00336213, 0.00319397],
                                [0.0542656, 0.0388094, 0.0197295, 0.0140321, 0.0105762, 0.00853633, 0.00718951, 0.00623375, 0.00561097, 0.00503868, 0.00458378, 0.00421344, 0.00390601, 0.00368118, 0.00345451, 0.00325866],
                                [0.0579869, 0.0411489, 0.0204848, 0.0131058, 0.0100219, 0.00814941, 0.00689237, 0.00599029, 0.0052279, 0.00471568, 0.00430354, 0.0039647, 0.00368113, 0.0034088, 0.00320586, 0.00302916],
                                [0.0592836, 0.0374723, 0.0203513, 0.0134723, 0.0104432, 0.00834062, 0.00696644, 0.00610339, 0.00535913, 0.00485138, 0.00438549, 0.00400825, 0.00373249, 0.003465, 0.00326397, 0.00306435],
                                [0.0653835, 0.0409715, 0.0206942, 0.0139344, 0.0105498, 0.0085172, 0.00716129, 0.00619231, 0.00546524, 0.00489948, 0.00444665, 0.00407598, 0.00376694, 0.0035053, 0.00328091, 0.00308633],
                                [0.0707857, 0.0442135, 0.0209396, 0.014345, 0.0106357, 0.00867186, 0.00733564, 0.00626488, 0.00555423, 0.00493333, 0.00449296, 0.00412908, 0.00378854, 0.00353298, 0.00328684, 0.00309752],
                                [0.0763489, 0.0423542, 0.0212378, 0.014762, 0.0110209, 0.00881199, 0.00735416, 0.00632023, 0.00562484, 0.00501132, 0.00452363, 0.0041267, 0.00379736, 0.00354837, 0.00330705, 0.00309869],
                                [0.0654826, 0.0363406, 0.0181721, 0.0116995, 0.00887221, 0.00715561, 0.00600382, 0.005178, 0.0044976, 0.00402641, 0.00364805, 0.0033376, 0.00307828, 0.00283606, 0.00265037, 0.00248902],
                                [0.0669693, 0.0336318, 0.0178017, 0.011724, 0.00898374, 0.00714176, 0.00593398, 0.00515503, 0.00450316, 0.00404625, 0.00363924, 0.00330921, 0.00306141, 0.00282806, 0.00264792, 0.00247426],
                                [0.0701999, 0.0352548, 0.0176835, 0.0118214, 0.00889157, 0.00713468, 0.00596399, 0.00512809, 0.00450135, 0.004014, 0.00362422, 0.00330537, 0.00303972, 0.002815, 0.00262242, 0.00245556],
                                [0.0991904, 0.0446731, 0.0222166, 0.0147865, 0.0110817, 0.00886254, 0.00738503, 0.0063309, 0.0055412, 0.00492769, 0.00443743, 0.00403677, 0.00370327, 0.0034214, 0.00318008, 0.00297118],
                                [0.106933, 0.0443428, 0.0221151, 0.014696, 0.0109876, 0.00876512, 0.00728561, 0.00623052, 0.00544055, 0.00482722, 0.00433746, 0.00393752, 0.00360489, 0.00332398, 0.00308369, 0.00287586],
                                [0.121503, 0.0463601, 0.0230315, 0.0152624, 0.0113849, 0.00906351, 0.00751953, 0.00641947, 0.00559657, 0.00495824, 0.00444893, 0.00403331, 0.00368785, 0.00339627, 0.00314694, 0.00293137],
                                [0.123089, 0.0444172, 0.0221453, 0.0146896, 0.0109613, 0.00872636, 0.00723831, 0.00617691, 0.00538206, 0.00476484, 0.00427193, 0.00386938, 0.00353457, 0.00325183, 0.00300998, 0.00280082],
                                [0.101495, 0.0336939, 0.0168125, 0.0111742, 0.00834907, 0.00665087, 0.0055172, 0.00470682, 0.00409893, 0.00362631, 0.00324852, 0.00293978, 0.00268287, 0.00246586, 0.0022802, 0.00211961],
                                [0.108746, 0.0333728, 0.0164342, 0.01084, 0.00806135, 0.00640139, 0.00529806, 0.00451177, 0.00392321, 0.00346629, 0.00310143, 0.00280348, 0.00255569, 0.00234647, 0.00216754, 0.00201282],
                                [0.116418, 0.034471, 0.0172375, 0.0114566, 0.00855492, 0.00680875, 0.00564219, 0.00480785, 0.00418169, 0.00369465, 0.00330517, 0.00298676, 0.00272171, 0.00249775, 0.0023061, 0.0021403],
                                [0.120946, 0.0341348, 0.0169426, 0.0111666, 0.00828414, 0.00656178, 0.00541828, 0.00460452, 0.00399621, 0.00352447, 0.00314811, 0.00284099, 0.0025857, 0.00237023, 0.00218602, 0.00202677],
                                [0.147759, 0.0377413, 0.0187165, 0.0123852, 0.00921745, 0.00731514, 0.00604621, 0.00513976, 0.00446023, 0.0039322, 0.00351033, 0.00316574, 0.00287915, 0.0026372, 0.00243031, 0.00225148],
                                [0.15687, 0.0370201, 0.0181379, 0.011925, 0.00883737, 0.00699234, 0.0057663, 0.00489307, 0.00423992, 0.00373327, 0.00332906, 0.00299926, 0.00272521, 0.00249401, 0.00229644, 0.00212575],
                                [0.14204, 0.0279865, 0.0138259, 0.00911259, 0.00675649, 0.0053428, 0.00440057, 0.00372802, 0.00322418, 0.00283293, 0.00252053, 0.00226552, 0.00205355, 0.0018747, 0.00172187, 0.00158984],
                                [0.129265, 0.0210319, 0.0103414, 0.00679137, 0.00502079, 0.00396058, 0.00325506, 0.00275204, 0.00237552, 0.0020833, 0.00185009, 0.00165978, 0.00150165, 0.00136826, 0.00125431, 0.00115591],
				[0.124298, 0.0174181, 0.00857577, 0.0056321, 0.00416202, 0.00328123, 0.00269497, 0.00227694, 0.00196402, 0.00172115, 0.00152731, 0.0013691, 0.00123763, 0.00112672, 0.00103195, 0.000950097],
				[0.0981173, 0.0124464, 0.00617934, 0.00406756, 0.00300844, 0.0023724, 0.00194837, 0.00164566, 0.00141885, 0.00124269, 0.00110201, 0.000987157, 0.000891676, 0.000811105, 0.000742253, 0.000682779],
                                [0.0875803, 0.00941078, 0.00465274, 0.00306806, 0.00227418, 0.00179675, 0.00147783, 0.00124969, 0.00107842, 0.000945177, 0.000838602, 0.000751467, 0.000678939, 0.000617666, 0.00056525, 0.00051993],
                                [0.0692494, 0.00686834, 0.00337032, 0.00221148, 0.00163443, 0.00128906, 0.00105922, 0.000895259, 0.000772429, 0.000676999, 0.000600741, 0.000538425, 0.000486568, 0.000442757, 0.000405272, 0.000372851],
                                [0.0490776, 0.00463327, 0.00229667, 0.00151283, 0.00112019, 0.000884598, 0.000727634, 0.000615605, 0.000531644, 0.000466383, 0.000414203, 0.000371534, 0.000335999, 0.000305953, 0.000280222, 0.000257947],
                                [0.0364037, 0.00324549, 0.00161686, 0.00107001, 0.000795059, 0.000629462, 0.000518784, 0.000439591, 0.000380126, 0.000333837, 0.000296786, 0.000266461, 0.000241188, 0.000219804, 0.000201479, 0.000185606]]

        marr = [300, 320, 340, 360, 380, 400, 420, 440, 460, 480, 500, 550, 600, 650, 700, 750, 800, 850, 900, 950, 1000, 1250, 1500, 1750, 2000, 2250, 2500, 2750, 3000]## GGF Cross-Section
        for index in range(len(marr)):
            if int(self.m) == marr[index]:
                self.xsec=theXsectionGGHtable[index][int(self.w)]
                self.xsec_vbf=theXsectionVBFtable[index][int(self.w)]
	print "mass: ", self.m
	print "width: ", self.w
	print "xsec: ", self.xsec, self.xsec_vbf


    def doParametersOfInterest(self):
        """Create POI and other parameters, and define the POI set."""
        if self.modelBuilder.out.var("r"):
            print "have r inside"
        else:
            self.modelBuilder.doVar("r[1,0,10000]")
        if self.modelBuilder.out.var("fvbf"):
            print "have fvbf inside"
        else:
            self.modelBuilder.doVar("fvbf[0,0,1]")
        if self.is2l2nu:
            self.setXsec()
            self.modelBuilder.factory_( "expr::CMS_zz2l2nu_mu(\"@0*(1-@1)*0.0673*0.2*2/1000./%f\", r,fvbf)" %(self.xsec))
            self.modelBuilder.factory_( "expr::CMS_zz2l2nu_mu_vbf(\"@0*@1*0.0673*0.2*2/1000./%f\", r,fvbf)" %(self.xsec_vbf))
            poi = "r"


        self.modelBuilder.factory_( "expr::ggH_s_func(\"@0-sqrt(@0)\", CMS_zz2l2nu_mu)")
        self.modelBuilder.factory_(  "expr::ggH_b_func(\"1-sqrt(@0)\", CMS_zz2l2nu_mu)")
        self.modelBuilder.factory_(  "expr::ggH_sbi_func(\"sqrt(@0)\", CMS_zz2l2nu_mu)")

        self.modelBuilder.factory_( "expr::qqH_s_func(\"@0-sqrt(@0)\", CMS_zz2l2nu_mu_vbf)")
        self.modelBuilder.factory_(  "expr::qqH_b_func(\"1-sqrt(@0)\", CMS_zz2l2nu_mu_vbf)")
        self.modelBuilder.factory_(  "expr::qqH_sbi_func(\"sqrt(@0)\", CMS_zz2l2nu_mu_vbf)")


	self.modelBuilder.doSet("POI",poi)



heavyscalarmod = HeavyScalarMod()
